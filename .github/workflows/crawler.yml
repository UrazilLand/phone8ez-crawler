name: SmartChoice Crawler

on:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'  # ë§¤ì¼ ìì • ì‹¤í–‰ (UTC ê¸°ì¤€)

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      with:
        persist-credentials: false

    - name: Python ì„¤ì¹˜
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Chrome ì„¤ì¹˜
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser

    - name: ì›¹ í¬ë¡¤ëŸ¬ ì‹¤í–‰
      run: |
        python smartchoice_crawler.py

    - name: 30ì¼ ì§€ë‚œ íŒŒì¼ ì‚­ì œ
      run: |
        find data/ -name '*.json' -type f -mtime +30 -print -delete
        git config --global user.name "UrazilLand Bot"
        git config --global user.email "urazilland@users.noreply.github.com"
        git add -u
        git commit -m "ğŸ§¹ 30ì¼ ì´ìƒ ì§€ë‚œ JSON íŒŒì¼ ì‚­ì œ" || echo "ì‚­ì œí•  íŒŒì¼ ì—†ìŒ"
        
    - name: Git ì„¤ì • ë° ê²°ê³¼ í‘¸ì‹œ
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "UrazilLand Bot"
        git config --global user.email "urazilland@users.noreply.github.com"
        
        # ìƒˆë¡œ ìƒì„±ëœ ëª¨ë“  JSON íŒŒì¼ì„ í¬í•¨í•˜ì—¬ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€
        git add data/*.json || echo "ì¶”ê°€í•  JSON íŒŒì¼ ì—†ìŒ"

        git commit -m "ğŸ“¦ ìë™ í¬ë¡¤ë§ ê²°ê³¼ ë°˜ì˜" || echo "ë³€ê²½ ì—†ìŒ"
        git pull --rebase origin main || echo "ì¶©ëŒ ì—†ìŒ"
        git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
